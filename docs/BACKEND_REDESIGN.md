# Backend Redesign (2025-11)

## Overview

The backend has been rebuilt around a single deterministic transformation pipeline:
settings.json (configuration) + monthly raw input files in `database/` => generated `dashboard/dashboard.json`.
All deprecated concepts (ECLI, basket of goods, city comparisons, legacy normalization flags) have been removed. Only HICP-based real wealth adjustments remain.

## Data Layers

1. settings.json: Base currency, HICP baseline, category classification lists.
2. Monthly input (`database/YYYY_MM.json`): Raw balances and cash flows. Accepts either `month` or `reference_month`; supports both `cash_flow_entries` and `cash-flow-entries` key forms.
3. dashboard.json: Fully derived data; contains no configuration.

## Generation Command

```
cargo run -p dashboard_engine --bin generate-dashboard -- \
  --settings settings.json \
  --database database \
  --out dashboard/dashboard.json
```

## Output Schema (dashboard.json)

- metadata: generated_at (RFC3339), settings_version
- yearly_stats[]: year aggregates (income, expenses, savings, average save rate)
- snapshots[] each month:
  - month (YYYY-MM)
  - fx_rates { <CUR>: rate }
  - hicp (raw index value for month)
  - totals { assets, liabilities, net_worth }
  - by_category.assets { liquidity, investments, retirement, personal }
  - by_category.liabilities { dynamic keyed sums }
  - cash_flow { income, expenses, net_cash_flow, save_rate }
  - performance { portfolio_nominal_return, portfolio_real_return, twr_cumulative }
  - real_wealth { net_worth_real, change_pct_from_prev }

## Computation Details

### 1. Currency Normalization

Every monetary field converted to base currency via provided FX rates.
`value_base = original_amount * fx_rate(currency)`

### 2. Classification

Balances whose `type` matches any entry in `settings.categories.liabilities` become liabilities; all other known asset category types (`liquidity`, `investments`, `retirement`, `personal`) accumulate under assets.

### 3. Totals

```
assets = sum(asset categories)
liabilities = sum(liabilities)
net_worth = assets - liabilities
```

### 4. Cash Flow

Entries split using `positive_cash_flows` and `negative_cash_flows` lists.

```
income = sum(positive entries in base currency)
expenses = sum(negative entries in base currency)   // stored as positive number
net_cash_flow = income - expenses
save_rate = income > 0 ? net_cash_flow / income : 0
```

### 5. Inflation & Real Wealth

```
inflation_factor = hicp_month / settings.hicp.base_value
net_worth_real = net_worth / inflation_factor
change_pct_from_prev = (current_real - prev_real) / prev_real (0 if first)
```

### 6. Portfolio Performance (Simplified)

Portfolio value = investments + retirement.
Nominal return (first month = 0):

```
nominal_return = (portfolio_current - portfolio_prev) / portfolio_prev
```

Real return removes monthly inflation drift approximately:

```
real_return = ((1 + nominal_return) / (inflation_factor / prev_inflation_factor)) - 1
```

Cumulative TWR approximated by chaining `(1 + nominal_return)` factors.

### 7. Yearly Stats

Group snapshots by year extracted from `month` string.

```
months_count = len(months)
total_income = sum(income)
total_expenses = sum(expenses)
total_savings = total_income - total_expenses
average_save_rate = mean(save_rate over months)
```

All monetary outputs rounded to 2 decimals; rates & returns to 4 decimals.

## Extensibility Notes

- Adding new asset categories: Update classification match logic in `dashboard_engine/src/lib.rs`.
- Additional performance metrics: Extend `SnapshotPerformance` struct; derive values before `finalize()` call.
- Alternative inflation index: Replace `hicp` field & formula; keep same structure for backward compatibility.

## Removed Components

- ECLI weights / normalization
- Basket of goods / city adjustments
- Legacy normalization flags (still accepted but ignored at input layer)

## Integration Path

Existing API can now serve the new `dashboard/dashboard.json` directly; repository layer would need updated structs mirroring the redesigned output if endpoints are to expose the richer snapshot schema.

## Next Ideas

- Track explicit investment cash flows to refine TWR calculation.
- Add per-category time series deltas & CAGR.
- Optional compression/encryption for `dashboard.json` prior to distribution.

---

Generated by the new `dashboard_engine` crate.
